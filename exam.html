<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Online Exam</title>
  <style>
    body {
      background-color: #121212;
      color: #f0f0f0;
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    .student-info {
      margin-bottom: 20px;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }

    .student-info img {
      height: 100px;
      border-radius: 8px;
    }

    .question {
      margin-bottom: 20px;
    }

    .options label {
      display: block;
      margin: 5px 0;
    }

    .timer {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #ff5555;
    }

    #submitBtn {
      padding: 10px 20px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #submitBtn:disabled {
      background-color: gray;
    }
  </style>
</head>
<body>
  <div class="student-info" id="studentInfo"></div>
  <div class="timer" id="timer">Loading timer...</div>
  <form id="examForm"></form>
  <button id="submitBtn">Submit</button>

  <script>
    const student = JSON.parse(localStorage.getItem("student"));
    const selectedExam = JSON.parse(localStorage.getItem("selectedExam"));

    if (!student || !selectedExam) {
      alert("Missing student or exam data. Please login and select exam again.");
      window.location.href = "student-login.html";
    }

    document.getElementById("studentInfo").innerHTML = `
      <h2>Online Exam</h2>
      <img src="${student.passport}" alt="Passport" />
      <p><strong>Name:</strong> ${student.name}</p>
      <p><strong>Matric:</strong> ${student.matric}</p>
      <p><strong>Department:</strong> ${student.department}</p>
      <p><strong>Course:</strong> ${selectedExam.courseTitle} (${selectedExam.courseCode})</p>
    `;

    // Timer
    let timeLeft = 900; // 15 minutes
    const timerDisplay = document.getElementById("timer");

    function updateTimer() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerDisplay.textContent = `Time Left: ${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        autoSubmit();
      }
      timeLeft--;
    }

    const timerInterval = setInterval(updateTimer, 1000);

    // Fetch questions
    async function loadQuestions() {
      try {
        const response = await fetch(`https://cbt-system.onrender.com/api/exams/${selectedExam.courseCode}/questions`);
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || "Failed to load questions.");
        }

        const data = await response.json();
        const questions = data.questions;

        if (!Array.isArray(questions)) {
          throw new Error("Invalid response format: questions should be an array.");
        }

        const form = document.getElementById("examForm");
        questions.forEach((q, i) => {
          const div = document.createElement("div");
          div.className = "question";
          div.innerHTML = `
            <p><strong>Q${i + 1}:</strong> ${q.question}</p>
            <div class="options">
              <label><input type="radio" name="q${q._id}" value="a" required /> a) ${q.options.a}</label>
              <label><input type="radio" name="q${q._id}" value="b" /> b) ${q.options.b}</label>
              <label><input type="radio" name="q${q._id}" value="c" /> c) ${q.options.c}</label>
              <label><input type="radio" name="q${q._id}" value="d" /> d) ${q.options.d}</label>
            </div>
          `;
          form.appendChild(div);
        });
      } catch (err) {
        alert("Failed to load questions: " + err.message);
        console.error(err);
      }
    }

    loadQuestions();

    // Submit
    document.getElementById("submitBtn").addEventListener("click", async () => {
      const form = document.getElementById("examForm");
      const formData = new FormData(form);
      const answers = {};

      for (let [key, value] of formData.entries()) {
        answers[key] = value;
      }

      const payload = {
        student: {
          name: student.name,
          matric: student.matric,
          department: student.department,
        },
        courseCode: selectedExam.courseCode,
        courseTitle: selectedExam.courseTitle,
        answers,
      };

      try {
        const response = await fetch("https://cbt-system.onrender.com/api/submissions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (response.ok) {
          alert("Exam submitted successfully!");
          window.location.href = "thankyou.html";
        } else {
          alert("Submission failed.");
        }
      } catch (err) {
        alert("An error occurred during submission.");
        console.error(err);
      }
    });

    // Auto submit
    function autoSubmit() {
      document.getElementById("submitBtn").click();
    }

    // Detect tab/browser hiding
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        alert("Exam tab was hidden. Auto-submitting.");
        autoSubmit();
      }
    });
  </script>
</body>
</html>
