<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Take Exam - Introduction to Computing</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: #f0f0f0;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .timer {
      font-size: 1.2em;
      font-weight: bold;
      color: #ff5555;
    }
    .question {
      margin-top: 20px;
      padding: 15px;
      background-color: #2a2a2a;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      margin-top: 20px;
      font-weight: bold;
      background-color: #0088cc;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0077b3;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>Introduction to Computing (CSC101)</h2>
    <div class="timer" id="timer">Loading timer...</div>
  </div>

  <div id="studentInfo"></div>
  <form id="examForm"></form>
  <button onclick="submitExam()">Submit Exam</button>

  <script>
    const courseCode = "COM101";
    const duration = 5 * 60; // 5 minutes
    let timeLeft = duration;
    let interval;
    let student = JSON.parse(localStorage.getItem("student"));

    if (!student) {
      alert("Student not logged in.");
      location.href = "student-login.html";
    }

    document.getElementById("studentInfo").innerHTML = `
      <p><strong>Name:</strong> ${student.name}</p>
      <p><strong>Matric:</strong> ${student.matric}</p>
      <p><strong>Department:</strong> ${student.department}</p>
    `;

    function startTimer() {
      interval = setInterval(() => {
        if (timeLeft <= 0) {
          clearInterval(interval);
          alert("Time is up! Submitting automatically.");
          submitExam();
        } else {
          const min = Math.floor(timeLeft / 60);
          const sec = timeLeft % 60;
          document.getElementById("timer").textContent = `${min}:${sec < 10 ? '0' : ''}${sec}`;
          timeLeft--;
        }
      }, 1000);
    }

    async function loadQuestions() {
      try {
        const res = await fetch(`/api/exams/${courseCode}/questions`);
        const data = await res.json();
        const questions = data.questions;
        const form = document.getElementById("examForm");
        form.innerHTML = "";

        questions.forEach((q, index) => {
          const div = document.createElement("div");
          div.className = "question";
          div.innerHTML = `
            <p><strong>Q${index + 1}:</strong> ${q.questionText}</p>
            ${['a', 'b', 'c', 'd'].map(opt =>
              `<label><input type="radio" name="q${index}" value="${opt}"> ${q.options[opt]}</label><br>`
            ).join('')}
          `;
          form.appendChild(div);
        });

        startTimer();
      } catch (err) {
        console.error("Failed to load questions", err);
        alert("Error loading questions.");
      }
    }

    async function submitExam() {
      clearInterval(interval);
      const answers = {};
      const questions = document.querySelectorAll(".question");
      questions.forEach((q, i) => {
        const selected = q.querySelector(`input[name="q${i}"]:checked`);
        answers[`q${i}`] = selected ? selected.value : null;
      });

      try {
        const res = await fetch(`/api/exams/${courseCode}/submit`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            studentMatric: student.matric,
            answers: answers,
          }),
        });

        const data = await res.json();
        if (res.ok) {
          alert("Exam submitted successfully!");
          window.location.href = "thankyou.html"; // Redirect or show confirmation
        } else {
          alert(data.message || "Submission failed.");
        }
      } catch (err) {
        console.error("Submit error:", err);
        alert("Failed to submit exam.");
      }
    }

    loadQuestions();
  </script>
</body>
</html>
